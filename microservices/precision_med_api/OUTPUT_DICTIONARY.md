# Carriers Pipeline Output Dictionary

Complete reference for all output files generated by `run_carriers_pipeline.py`.

---

## Output Files Overview

| File Pattern | Format | Description |
|-------------|--------|-------------|
| `{job}_NBA.parquet` | Parquet | Genotype matrix for NeuroBooster Array |
| `{job}_WGS.parquet` | Parquet | Genotype matrix for Whole Genome Sequencing |
| `{job}_IMPUTED.parquet` | Parquet | Genotype matrix for imputed genotypes |
| `{job}_EXOMES.parquet` | Parquet | Genotype matrix for exome sequencing (release 8+) |
| `{job}_{type}_variant_summary.csv` | CSV | Per-variant metadata summary |
| `{job}_locus_reports_{type}.csv` | CSV | Clinical phenotype statistics by locus |
| `{job}_locus_reports_{type}.json` | JSON | Full locus report with nested structure |
| `{job}_probe_selection.json` | JSON | NBA probe quality validation against WGS |
| `{job}_pipeline_results.json` | JSON | Execution metadata and summary |
| `{job}_coverage_by_locus.csv` | CSV | SNP list coverage by gene (optional) |
| `{job}_coverage_by_variant.csv` | CSV | Per-variant coverage flags (optional) |
| `{job}_coverage_summary.json` | JSON | Aggregate coverage statistics (optional) |
| `{job}_failed_files.json` | JSON | Failed extraction files (only if errors) |

---

## 1. Genotype Parquet Files

**Files:** `{job}_NBA.parquet`, `{job}_WGS.parquet`, `{job}_IMPUTED.parquet`, `{job}_EXOMES.parquet`

Wide-format genotype matrices with variants as rows and samples as columns.

### Metadata Columns (14)

| Column | Type | Description |
|--------|------|-------------|
| `chromosome` | str | Chromosome number (e.g., "1", "12", "X") |
| `variant_id` | str | Unique variant identifier (format varies by data type) |
| `(C)M` | float | Centimorgan position (TRAW format; usually constant or NaN) |
| `position` | int | Genomic position (GRCh38) |
| `counted_allele` | str | The pathogenic/risk allele being counted |
| `alt_allele` | str | The other allele (reference) |
| `harmonization_action` | str | How variant was matched: EXACT, FLIP, SWAP, FLIP_SWAP, or None |
| `snp_list_id` | str | Mutation name from SNP list (e.g., "p.Gly2019Ser", "N370S") |
| `pgen_a1` | str | Original allele 1 from pgen file (before harmonization) |
| `pgen_a2` | str | Original allele 2 from pgen file (before harmonization) |
| `data_type` | str | Source data type: NBA, WGS, IMPUTED, or EXOMES |
| `source_file` | str | Path to source pgen file |
| `maf_corrected` | bool | True if genotypes were flipped due to ALT AF > 0.5 |
| `original_alt_af` | float | Original alternate allele frequency before MAF correction |

### Sample Columns

All remaining columns are sample IDs with genotype values:
- **0** = Homozygous reference (no pathogenic alleles)
- **1** = Heterozygous (one pathogenic allele)
- **2** = Homozygous alternate (two pathogenic alleles)

Sample ID format: Cohort prefix + underscore + number (e.g., `PPMI_001234`, `APGS_000567`)

---

## 2. Variant Summary CSV

**Files:** `{job}_NBA_variant_summary.csv`, `{job}_WGS_variant_summary.csv`, etc.

Per-variant metadata without sample genotypes. Useful for quick lookup of which variants were extracted.

| Column | Type | Description |
|--------|------|-------------|
| `variant_id` | str | Unique variant identifier |
| `snp_list_id` | str | Mutation name from SNP list |
| `chromosome` | int | Chromosome number |
| `position` | int | Genomic position (GRCh38) |
| `original_a1` | str | Original allele 1 from source file (same as pgen_a1) |
| `original_a2` | str | Original allele 2 from source file (same as pgen_a2) |
| `counted_allele` | str | Allele being counted as pathogenic |
| `alt_allele` | str | Alternate allele |
| `harmonization_action` | str | Match type: EXACT, FLIP, SWAP, FLIP_SWAP |
| `data_type` | str | Source data type |
| `source_file` | str | Path to source pgen file |

---

## 3. Locus Reports CSV

**Files:** `{job}_locus_reports_NBA.csv`, `{job}_locus_reports_WGS.csv`, etc.

Clinical phenotype statistics aggregated by gene (locus) and ancestry.

| Column | Type | Description |
|--------|------|-------------|
| `locus` | str | Gene name (e.g., GBA1, LRRK2, PRKN) |
| `data_type` | str | Data source (NBA, WGS, IMPUTED) |
| `ancestry` | str | Genetic ancestry code (AAC, EUR, EAS, etc.) |
| `total_carriers` | int | Total carriers of any variant in this locus |
| `carriers_with_clinical_data` | int | Carriers found in master key with clinical data |
| `hy_available` | int | Carriers with Hoehn & Yahr stage recorded |
| `hy_less_than_2` | int | Carriers with H&Y < 2 (early stage) |
| `hy_less_than_3` | int | Carriers with H&Y < 3 (mild disease) |
| `moca_available` | int | Carriers with MoCA score recorded |
| `moca_gte_20` | int | Carriers with MoCA >= 20 (normal cognition) |
| `moca_gte_24` | int | Carriers with MoCA >= 24 (no cognitive impairment) |
| `dat_caudate_available` | int | Carriers with DAT-SPECT caudate data |
| `disease_duration_lte_5_years` | int | Carriers with disease duration <= 5 years |
| `disease_duration_lte_7_years` | int | Carriers with disease duration <= 7 years |
| `clinical_data_availability_pct` | str | Percentage of carriers with any clinical data (e.g., "70.7%") |

---

## 4. Locus Reports JSON

**Files:** `{job}_locus_reports_NBA.json`, `{job}_locus_reports_WGS.json`, etc.

Complete structured locus report with nested hierarchy.

### Top-Level Structure

```json
{
  "job_id": "release10",
  "analysis_timestamp": "2025-10-13T23:36:50",
  "data_type": "NBA",
  "summary": { ... },
  "locus_reports": [ ... ],
  "clinical_data_sources": { ... },
  "loci_analyzed": ["GBA1", "LRRK2", ...],
  "top_loci_by_carriers": [["GBA1", 1234], ...]
}
```

### Summary Object

| Field | Type | Description |
|-------|------|-------------|
| `total_loci_analyzed` | int | Number of genes analyzed |
| `total_carriers_identified` | int | Total carrier count across all loci |
| `total_samples_analyzed` | int | Number of samples in dataset |
| `total_samples_with_clinical_data` | int | Samples matched to master key |
| `total_variants` | int | Number of unique variants |
| `ancestries_represented` | list[str] | Ancestry codes present |
| `carriers_by_ancestry` | dict | Carrier counts per ancestry |

### Locus Report Object

| Field | Type | Description |
|-------|------|-------------|
| `locus` | str | Gene name |
| `by_ancestry` | list | Clinical metrics per ancestry (same as CSV columns) |
| `total_metrics` | object | Aggregated metrics across all ancestries |
| `variant_details` | list | Per-variant carrier counts |
| `n_variants` | int | Number of variants in this locus |
| `variant_ids` | list[str] | List of variant IDs |
| `ancestries_represented` | list[str] | Ancestries with carriers |
| `total_carriers_all_ancestries` | int | Total carrier count |

### Variant Details Object

| Field | Type | Description |
|-------|------|-------------|
| `variant_id` | str | Variant identifier |
| `mutation_name` | str | Human-readable mutation name |
| `chromosome` | str | Chromosome |
| `position` | int | Genomic position |
| `ref_allele` | str | Reference allele |
| `alt_allele` | str | Alternate allele |
| `carrier_count` | int | Total carriers (het + hom) |
| `heterozygous_count` | int | Heterozygous carriers |
| `homozygous_count` | int | Homozygous carriers |

---

## 5. Probe Selection JSON

**File:** `{job}_probe_selection.json`

Quality validation of NBA probes against WGS ground truth. Only generated when both NBA and WGS data are processed.

### Top-Level Structure

```json
{
  "job_id": "release10",
  "analysis_timestamp": "2025-10-13T23:40:00",
  "methodology": {
    "analysis_methods": ["diagnostic", "concordance"],
    "recommendation_strategy": "consensus"
  },
  "summary": { ... },
  "probe_comparisons": [ ... ],
  "methodology_comparison": { ... }
}
```

### Summary Object

| Field | Type | Description |
|-------|------|-------------|
| `total_mutations_analyzed` | int | Unique mutations evaluated |
| `mutations_with_multiple_probes` | int | Mutations with >1 NBA probe |
| `total_probe_comparisons` | int | Total probe-level comparisons |
| `samples_compared` | int | Samples with both NBA and WGS data |

### Probe Comparison Object

| Field | Type | Description |
|-------|------|-------------|
| `mutation` | str | Mutation name |
| `snp_list_id` | str | SNP list identifier |
| `chromosome` | int | Chromosome |
| `position` | int | Genomic position |
| `wgs_ground_truth_cases` | int | WGS carriers used as truth |
| `probes` | list | Per-probe analysis results |
| `diagnostic_recommendation` | object | Best probe by diagnostic metrics |
| `concordance_recommendation` | object | Best probe by concordance |
| `consensus` | object | Final recommendation |

### Diagnostic Metrics Object

| Field | Type | Description |
|-------|------|-------------|
| `true_positives` | int | Correctly identified carriers |
| `false_positives` | int | Non-carriers called as carriers |
| `false_negatives` | int | Carriers missed |
| `true_negatives` | int | Correctly identified non-carriers |
| `sensitivity` | float | TP / (TP + FN) |
| `specificity` | float | TN / (TN + FP) |
| `ppv` | float | Positive predictive value |
| `npv` | float | Negative predictive value |

### Concordance Metrics Object

| Field | Type | Description |
|-------|------|-------------|
| `total_samples_compared` | int | Samples in comparison |
| `transition_matrix` | object | 3x3 genotype concordance matrix |
| `overall_concordance` | float | Fraction of exact genotype matches |
| `wt_concordance` | float | Wild-type concordance |
| `het_concordance` | float | Heterozygote concordance |
| `hom_concordance` | float | Homozygote concordance |
| `false_negatives` | int | Carriers missed by NBA |
| `false_positives` | int | Non-carriers called by NBA |
| `quality_score` | float | Composite quality metric |

### Transition Matrix Fields

| Field | Description |
|-------|-------------|
| `nba_0_wgs_0` | NBA=0, WGS=0 (true negative) |
| `nba_0_wgs_1` | NBA=0, WGS=1 (false negative het) |
| `nba_0_wgs_2` | NBA=0, WGS=2 (false negative hom) |
| `nba_1_wgs_0` | NBA=1, WGS=0 (false positive het) |
| `nba_1_wgs_1` | NBA=1, WGS=1 (true positive het) |
| `nba_1_wgs_2` | NBA=1, WGS=2 (het/hom mismatch) |
| `nba_2_wgs_0` | NBA=2, WGS=0 (false positive hom) |
| `nba_2_wgs_1` | NBA=2, WGS=1 (hom/het mismatch) |
| `nba_2_wgs_2` | NBA=2, WGS=2 (true positive hom) |

---

## 6. Pipeline Results JSON

**File:** `{job}_pipeline_results.json`

Execution metadata and aggregate statistics.

| Field | Type | Description |
|-------|------|-------------|
| `job_id` | str | Job name |
| `start_time` | str | ISO timestamp of start |
| `end_time` | str | ISO timestamp of completion |
| `success` | bool | Whether pipeline completed successfully |
| `execution_time_seconds` | float | Total runtime in seconds |
| `errors` | list[str] | Error messages (empty if success) |
| `output_files` | object | Paths to all generated files |
| `summary` | object | Aggregate statistics |
| `extraction_plan` | object | Input configuration |

### Summary Object

| Field | Type | Description |
|-------|------|-------------|
| `total_variants` | int | Total variant rows across all types |
| `unique_variants` | int | Unique variants by snp_list_id |
| `total_samples` | int | Unique samples extracted |
| `extraction_timestamp` | str | When extraction completed |
| `by_data_type` | object | Per-type variant and sample counts |

---

## 7. Coverage Files (Optional)

Generated when `--skip-coverage-profiling` is not set.

### coverage_by_locus.csv

| Column | Type | Description |
|--------|------|-------------|
| `locus` | str | Gene name |
| `chromosome` | str | Chromosome |
| `total_variants` | int | Variants in SNP list for this locus |
| `wgs_exact` | int | Exact matches in WGS |
| `wgs_position` | int | Position matches in WGS |
| `wgs_exact_pct` | float | Exact match percentage |
| `wgs_position_pct` | float | Position match percentage |
| (same pattern for `imputed_`, `nba_`, `exomes_`) |

### coverage_by_variant.csv

| Column | Type | Description |
|--------|------|-------------|
| `variant_id` | str | SNP list variant ID |
| `snp_name` | str | Mutation name |
| `locus` | str | Gene name |
| `chr` | str | Chromosome |
| `pos` | str | Position |
| `rsid` | str | dbSNP ID (if available) |
| `WGS_exact` | bool | Found exact match in WGS |
| `WGS_position` | bool | Found position match in WGS |
| (same pattern for `IMPUTED_`, `NBA_`, `EXOMES_`) |

---

## Allele Column Reference

### Understanding Allele Columns

| Column | Source | Description |
|--------|--------|-------------|
| `counted_allele` | SNP list | The pathogenic/risk allele being counted (always populated) |
| `alt_allele` | SNP list | The other allele - typically the reference (always populated) |
| `pgen_a1` | PGEN file | Original allele 1 from source file before harmonization |
| `pgen_a2` | PGEN file | Original allele 2 from source file before harmonization |

### How Harmonization Works

The relationship between `pgen_a1/a2` and `counted_allele/alt_allele` depends on the harmonization action:

| Action | Relationship | Description |
|--------|--------------|-------------|
| **SWAP** | `pgen_a1 = counted_allele` | Direct match, no transformation needed |
| **EXACT** | `pgen_a2 = counted_allele` | Alleles reversed in source file |
| **FLIP** | `complement(pgen_a2) = counted_allele` | Strand flip (A↔T, G↔C) |
| **FLIP_SWAP** | `complement(pgen_a1) = counted_allele` | Both reversed and strand-flipped |
| **None** | N/A | Variant not found in source file |

---

## Data Type Comparison

| Feature | NBA | WGS | IMPUTED | EXOMES |
|---------|-----|-----|---------|--------|
| Sample count | ~83,000 | ~21,000 | ~83,000 | Varies |
| Variant source | Array probes | Called variants | Imputed from reference | Called variants |
| Allele format | Various | chr:pos:ref:alt | chr:pos:ref:alt | chr:pos:ref:alt |
| Multiple probes | Yes (77 SNPs) | No | No | No |
| Ground truth | No | Yes | No | No |
| MAF correction | Supported | Supported | Supported | Supported |

---

## Usage Examples

### Load Genotype Data (Python)
```python
import pandas as pd

df = pd.read_parquet("release10_NBA.parquet")
metadata_cols = ['chromosome', 'variant_id', 'position', 'snp_list_id', ...]
sample_cols = [c for c in df.columns if c not in metadata_cols]
```

### Find Carriers of a Specific Variant
```python
variant = df[df['snp_list_id'] == 'p.Gly2019Ser']
carriers = variant[sample_cols].T
het_carriers = carriers[carriers[carriers.columns[0]] == 1].index.tolist()
hom_carriers = carriers[carriers[carriers.columns[0]] == 2].index.tolist()
```

### Merge with Clinical Data
```python
locus_df = pd.read_csv("release10_locus_reports_NBA.csv")
gba1_eur = locus_df[(locus_df['locus'] == 'GBA1') & (locus_df['ancestry'] == 'EUR')]
```
