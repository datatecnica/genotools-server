"""Shell script generator for PLINK commands.

[claude-assisted] Implements Run-plink.sh generation matching the original
Perl script's output (lines 251-296).

Generated script applies all corrections in order:
1. Exclude problematic variants
2. Update chromosomes
3. Update positions
4. Flip strands
5. Force reference alleles
6. Split into per-chromosome files
"""

from pathlib import Path


def write_shell_script(
    output_dir: Path,
    file_stem: str,
    panel_name: str,
    plink_path: str = "plink",
) -> Path:
    """Generate Run-plink.sh script for applying corrections.

    Args:
        output_dir: Directory for output files
        file_stem: Base filename (from BIM file)
        panel_name: Reference panel name ("HRC" or "1000G")
        plink_path: Path to PLINK executable (default: "plink")

    Returns:
        Path to generated script file
    """
    script_path = output_dir / "Run-plink.sh"

    # File names
    exclude = f"Exclude-{file_stem}-{panel_name}.txt"
    chromosome = f"Chromosome-{file_stem}-{panel_name}.txt"
    position = f"Position-{file_stem}-{panel_name}.txt"
    strand = f"Strand-Flip-{file_stem}-{panel_name}.txt"
    force = f"Force-Allele1-{file_stem}-{panel_name}.txt"

    updated = f"{file_stem}-updated"

    with open(script_path, "w") as f:
        f.write("#!/bin/bash\n\n")
        f.write(f"# Generated by imputation-harmonizer for {panel_name}\n")
        f.write("# This script applies all corrections identified during QC\n\n")

        # Step 1: Remove excluded SNPs
        f.write("# Step 1: Remove excluded SNPs\n")
        f.write(
            f"{plink_path} --bfile {file_stem} --exclude {exclude} "
            f"--make-bed --out TEMP1\n\n"
        )

        # Step 2: Update chromosomes
        f.write("# Step 2: Update chromosomes\n")
        f.write(
            f"{plink_path} --bfile TEMP1 --update-map {chromosome} "
            f"--update-chr --make-bed --out TEMP2\n\n"
        )

        # Step 3: Update positions
        f.write("# Step 3: Update positions\n")
        f.write(
            f"{plink_path} --bfile TEMP2 --update-map {position} "
            f"--make-bed --out TEMP3\n\n"
        )

        # Step 4: Flip strand
        f.write("# Step 4: Flip strand\n")
        f.write(
            f"{plink_path} --bfile TEMP3 --flip {strand} "
            f"--make-bed --out TEMP4\n\n"
        )

        # Step 5: Force reference allele (final output)
        f.write("# Step 5: Force reference allele\n")
        f.write(
            f"{plink_path} --bfile TEMP4 --reference-allele {force} "
            f"--make-bed --out {updated}\n\n"
        )

        # Step 6: Split into per-chromosome files
        f.write("# Step 6: Split into per-chromosome files for imputation server\n")
        f.write("for i in {1..22}; do\n")
        f.write(
            f"    {plink_path} --bfile {updated} --reference-allele {force} "
            f"--chr $i --make-bed --out {updated}-chr$i\n"
        )
        f.write("done\n\n")

        # Cleanup
        f.write("# Cleanup temporary files\n")
        f.write("rm TEMP*\n")

    # Make script executable
    script_path.chmod(0o755)

    return script_path


def write_shell_script_with_id_update(
    output_dir: Path,
    file_stem: str,
    panel_name: str,
    plink_path: str = "plink",
) -> Path:
    """Generate Run-plink.sh script including ID update step.

    This version includes the optional ID update step (commented out
    in the original Perl script).

    Args:
        output_dir: Directory for output files
        file_stem: Base filename (from BIM file)
        panel_name: Reference panel name ("HRC" or "1000G")
        plink_path: Path to PLINK executable (default: "plink")

    Returns:
        Path to generated script file
    """
    script_path = output_dir / "Run-plink.sh"

    # File names
    exclude = f"Exclude-{file_stem}-{panel_name}.txt"
    chromosome = f"Chromosome-{file_stem}-{panel_name}.txt"
    position = f"Position-{file_stem}-{panel_name}.txt"
    strand = f"Strand-Flip-{file_stem}-{panel_name}.txt"
    force = f"Force-Allele1-{file_stem}-{panel_name}.txt"
    id_file = f"ID-{file_stem}-{panel_name}.txt"

    updated = f"{file_stem}-updated"

    with open(script_path, "w") as f:
        f.write("#!/bin/bash\n\n")
        f.write(f"# Generated by imputation-harmonizer for {panel_name}\n")
        f.write("# This script applies all corrections identified during QC\n")
        f.write("# (includes optional ID update step)\n\n")

        # Step 1: Remove excluded SNPs
        f.write("# Step 1: Remove excluded SNPs\n")
        f.write(
            f"{plink_path} --bfile {file_stem} --exclude {exclude} "
            f"--make-bed --out TEMP1\n\n"
        )

        # Step 2: Update chromosomes
        f.write("# Step 2: Update chromosomes\n")
        f.write(
            f"{plink_path} --bfile TEMP1 --update-map {chromosome} "
            f"--update-chr --make-bed --out TEMP2\n\n"
        )

        # Step 3: Update positions
        f.write("# Step 3: Update positions\n")
        f.write(
            f"{plink_path} --bfile TEMP2 --update-map {position} "
            f"--make-bed --out TEMP3\n\n"
        )

        # Step 4: Flip strand
        f.write("# Step 4: Flip strand\n")
        f.write(
            f"{plink_path} --bfile TEMP3 --flip {strand} "
            f"--make-bed --out TEMP4\n\n"
        )

        # Step 5: Update SNP IDs
        f.write("# Step 5: Update SNP IDs to match reference\n")
        f.write(
            f"{plink_path} --bfile TEMP4 --update-map {id_file} "
            f"--update-name --make-bed --out TEMP5\n\n"
        )

        # Step 6: Force reference allele (final output)
        f.write("# Step 6: Force reference allele\n")
        f.write(
            f"{plink_path} --bfile TEMP5 --reference-allele {force} "
            f"--make-bed --out {updated}\n\n"
        )

        # Step 7: Split into per-chromosome files
        f.write("# Step 7: Split into per-chromosome files for imputation server\n")
        f.write("for i in {1..22}; do\n")
        f.write(
            f"    {plink_path} --bfile {updated} --reference-allele {force} "
            f"--chr $i --make-bed --out {updated}-chr$i\n"
        )
        f.write("done\n\n")

        # Cleanup
        f.write("# Cleanup temporary files\n")
        f.write("rm TEMP*\n")

    # Make script executable
    script_path.chmod(0o755)

    return script_path
